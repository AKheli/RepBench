{% extends "displayDataset/displayDatasetSynthetic.html" %}
{% load static %}


{% block content %}
    <script src="{% static 'js/repBench/recommendation/flamlCharts.js' %}" type="text/javascript"></script>
    <style>
        .kt-checkbox > span::after {
            border: solid green;
        }

        #start-button-right-text {
            color: gray;
        }
    </style>

    <style>
        #parameterTable {
            border-collapse: collapse;
            width: 100%;
        }

        #parameterTable th,
        #parameterTable td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        #parameterTable th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        #parameterTable .parameters-cell p {
            margin: 2px 0;
        }
    </style>

    {% include "recommendation/recommendation-script.html" %}

    <div class="row">
        {% block recommendation_computation %}
            <div class="col-md-12">

                {% include 'recommendation/flaml-example.html' %}
            </div>
        {% endblock %}


        <div class="kt-portlet col-md-3">
            <div class="kt-portlet__head">
                <div class="kt-portlet__head-label">
                    <h3 class="kt-portlet__head-title"> Classification Probabilities </h3>
                </div>
                <div class="kt-portlet__head-toolbar">
                </div>
            </div>
            <div class="kt-portlet__body kt-portlet__body--fit">


                <div id="probabilities-chart" class="mybox-content"></div>
            </div>
        </div>

        <div id="main-chart" class="col-md-6">
            <div class="kt-portlet">
                <div class="kt-portlet__head">
                    <div class="kt-portlet__head-label">
                        <h3 class="kt-portlet__head-title">
                            <row style="display: flex; align-items: center; justify-content: flex-end;">
                                <form id="select-dataset" action="" onsubmit="return false">
                                    {% csrf_token %}
                                    {% for field in  injected_datasets_form.visible_fields %}
                                        {{ field }}
                                    {% endfor %}
                                </form>
                                <button class="btn btn-primary disabled" style="margin-left:10px"
                                        onclick="getPrediction()">Recommend
                                </button>
                            </row>
                        </h3>
                    </div>
                    <div class="kt-portlet__head-toolbar">
                        <div id="highcharts_head_actions" class="kt-portlet__head-actions">
                            {#                        <a id="reset_chart_btn" class="btn btn-outline-brand btn-bold btn-sm"#}
                            {#                           onclick="chartManager.clearAllSeries();return false;">Reset</a>#}
                            <div class="dropdown dropdown-inline">
                                <a href="#" class="btn btn-outline-brand btn-icon btn-sm" data-toggle="dropdown"
                                   aria-haspopup="true" aria-expanded="false">
                                    <i class="mdi mdi-18px mdi-dots-horizontal"></i>
                                </a>
                                <div class="dropdown-menu dropdown-menu-right">
                                    <ul class="kt-nav">
                                        <li class="kt-nav__section kt-nav__section--first">
                                            <span class="kt-nav__section-text">Load Data</span>
                                        </li>
                                        <li class="kt-nav__item">
                                            <a id="raw_btn" onclick="chartManager.setOriginal(); return false;"
                                               class="kt-nav__link">
                                                <span class="kt-nav__link-text">Raw</span>
                                            </a>
                                        </li>
                                        <li class="kt-nav__item">
                                            <a id="zscore_btn" onclick="chartManager.setZscore(); return false;"
                                               class="kt-nav__link">
                                                <span class="kt-nav__link-text">Normalized</span>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="dropdown dropdown-inline">
                                <a class="btn btn-outline-brand btn-icon btn-sm" onclick="toggleChart()">
                                    <i id="chart-resize-id" class="mdi mdi-18px mdi-plus"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="kt-portlet__body kt-portlet__body--fit">
                </div>
                <script src="{% static 'js/lib/binarytransport/jquery.binarytransport.js' %}"
                        type="text/javascript"></script>
                <script src="http://code.highcharts.com/stock/highstock.js"></script>
                <script src="http://code.highcharts.com/maps/modules/map.js"></script>
                <script src="https://code.highcharts.com/modules/accessibility.js"></script>


                <div id="highcharts_container"></div>


                <script>
                    let datasetName = "{{ set_name }}";
                    let chart_title = "{{ data_title }}"
                    const timeInterval = "{{ 100000 }}";
                    chartHeight = 400;
                </script>

                <script src="{% static 'js/repBench/mainChart/additionalSeriesManager.js' %}"
                        type="text/javascript"></script>
                <script src="{% static 'js/repBench/mainChart/mainChart.js' %}" type="text/javascript"></script>
                <!--begin: Highcharts -->
                {#                {% include 'parts/MainChart.html' with chartHeight=400 %}#}
                <!--end: Highcharts -->
            </div>
        </div>


        <div class="kt-portlet col-md-3">
            <div class="kt-portlet__head">
                <div class="kt-portlet__head-label">
                    <h3 class="kt-portlet__head-title"> Scores for each Algorithm</h3>
                </div>
                <div class="kt-portlet__head-toolbar">
                </div>
            </div>
            <div class="kt-portlet__body kt-portlet__body--fit">

                <div id="alg-scores-chart" class="mybox-content"></div>
            </div>
        </div>


    </div>
{% endblock %}


{% block additional_bottom_js %}
    {#    <script type="text/javascript">#}
    {#        let recommendation_url = "{% url 'get_recommendation' setname=setname %}"#}
    {#    </script>#}
    {#    <script src="{% static 'js/repair.js' %}" type="text/javascript"></script>#}
    <script src="{% static 'js/repBench/recommendation/recommendation_charts.js' %}" type="text/javascript"></script>
    {#    <script src="{% static 'js/repBench/recommendation/recommendation.js' %}" type="text/javascript"></script>#}
    <script>
        {#createEmptyChart(1000);#}

        function toggleChart() {
            var icon = document.getElementById('chart-resize-id');
            var chart = document.getElementById('main-chart');
            if (chart.classList.contains('col-md-12')) {
                icon.classList.remove('mdi-minus');
                icon.classList.add('mdi-plus');
                chart.classList.remove('col-md-12');
                chart.classList.add('col-md-4');
            } else {
                icon.classList.remove('mdi-plus');
                icon.classList.add('mdi-minus');
                chart.classList.remove('col-md-4');
                chart.classList.add('col-md-12');
            }
        }

        var selectElement = document.getElementById("selected_dataset_title");

        function updateChart() {
            var selectedDataset = document.getElementById("selected_dataset_title").value;

            {#let data_url = '{% url data_fetch_url_name setname=setname  %}' + '?RepBenchWeb={{ RepBenchWeb|default_if_none:5 }}'#}

            // Construct the data URL with the selected dataset value
            var dataUrl = '{% url 'get_data' setname="placeholder" %}'.replace("placeholder", encodeURIComponent(selectedDataset));

            // Fetch the main chart data using the constructed data URL
            createEmptyChart(1000);
            var mainChartFetchPromise = fetchMainChartData(dataUrl);
        }

        selectElement.addEventListener("change", function (event) {
            event.preventDefault(); // Prevent the default form submission behavior

            // Submit the form
            updateChart()
        });
        updateChart()

        function getPrediction() {
            var selectedDataset = document.getElementById("selected_dataset_title").value;

            const predictionUrl = '{% url 'get_recommendation' setname="placeholder" %}'.replace("placeholder", encodeURIComponent(selectedDataset))
            mainChart.showLoading()
            console.log("get_prediction")
            $.ajax({
                type: 'POST',
                url: predictionUrl,
                data: $('#start-form').serialize() + '&task_id=' + recommendationHandler.task_id,
                success: function (response) {
                    console.log("got results");
                    console.log("EYYY", response);

                    const repairs = response.alg_repairs
                    const best_alg = response.recommended_algorithm[0]
                    Object.entries(repairs).forEach(([repairs_key, repairs_values]) => {
                            Object.entries(repairs_values).forEach(([key, value]) => {
                                console.log(key, value)

                                value.legendIndex = repairs_key === best_alg ? -2 : -1
                                value.visible = repairs_key === best_alg
                                value.name = repairs_key === best_alg ? value.name + " (recommendation)" : value.name
                                chartManager.addSeries(value, true, "repair")
                            });
                        },
                    );
                    createProbabilityChart(response.probabilities)
                    createErrorChart(response.alg_scores)
                    mainChart.hideLoading()

                },
                error: function (response) {
                    console.log("ERROR");
                    console.log("Status:", response.status);
                    console.log("Error message:", response.responseText);
                    alert('Error retrieving Flaml prediction');
                }
            });
        }
    </script>
{% endblock %}