{% extends "base.html" %}
{% load static %}

<!-- base template with a chart container of a dataset-->
{% block chartScript %}
    <script>
        let datasetName = "{{ set_name }}";
        let chart_title = "{{ data_title }}"

        let tooltip = {
            formatter: function (e) {
                // The first returned item is the header, subsequent items are the
                // points
                let x = this.x
                return ['<p style=\"color:black;font-size:15px;\"> Truth: ' + this.y + '</p>'].concat(
                    this.series.linkedSeries.map(function (s) {
                        selectedY = s.yData[x]
                        if (selectedY !== null) {
                            selectedY = Math.round(selectedY * 1000) / 1000
                            if (s.name.includes('injected')) {
                                return "<br> <p style=\"color:red;font-size:15px;\"> Anomalous: " + selectedY + "<\p> "
                            } else return "<br> <p style=\"color:" + s.color + ";font-size:15px;\">" + s.name + ": " + selectedY + "<\p> "
                        } else return ""
                    })
                );
            },
            shared: false,
            valueDecimals: 2
        }

        let range_selector = {
            buttons: [{
                count: 1,
                text: '1m',
                events: {
                    click: function () {
                        alert('Clicked button');
                    }
                }
            },
                {
                    count: 3,
                    text: '3m'
                }
            ],
            enabled: true,
        }
    </script>
{% endblock %}


{% block chart %}
    <script src="{% static 'js/lib/binarytransport/jquery.binarytransport.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/lib/highcharts/highstock.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/custom/highcharts.utils.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/custom/highcharts.line.view.init.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/custom/highcharts.actions.init.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/custom/form.extensions.js' %}" type="text/javascript"></script>

    <style>  .full-height {
        height: 98%;
    {#float: right;#}
    }

    .margin-top-20 {
        margin-top: 20px;
        left: 0;
    {#float: right;#}
    }

    </style>
    <div class="row full-height margin-top-20">
        <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 full-height ">
            <div class="kt-portlet full-height">
                <div class="kt-portlet__head--sm">
                    {#                    <div class="kt-portlet__head-label">#}
                    {#                        <h3 class="kt-portlet__head-title">{{ data_title }}</h3>#}
                    {#                    </div>#}
                    {#                    <div class="kt-portlet__head-toolbar">#}
                    {#                        <div id="highcharts_head_actions" class="kt-portlet__head-actions">#}
                    {#                            <a id="reset_chart_btn" href="#" class="btn btn-outline-brand btn-bold btn-sm">Reset</a>#}
                    {#                            <div class="dropdown dropdown-inline">#}
                    {#                                <a href="#" class="btn btn-outline-brand btn-icon btn-sm" data-toggle="dropdown"#}
                    {#                                   aria-haspopup="true" aria-expanded="false">#}
                    {#                                    <i class="mdi mdi-18px mdi-dots-horizontal"></i>#}
                    {#                                </a>#}
                    {#                                {% include 'vadetisweb/parts/misc/highcharts_line_dropdown.html' %}#}
                    {#                            </div>#}
                    {#                        </div>#}
                    {#                    </div>#}
                </div>
                <div class="kt-portlet__body kt-portlet__body--fit full-height">

                    <!--begin: Highcharts -->
                    <div id="highcharts_container" class="full-height"></div>
                    <!--end: Highcharts -->
                </div>
            </div>
            {#            <!--begin: Inner Row  block below the main chart -->#}
            {#            {% block innerRow %}#}
            {#            {% endblock %}#}
            {##}
            {#            <!--end: Inner Row -->#}
        </div>
        <!--end: Inner Row -->
        <div id="form_portlets" class="col-lg-3 col-md-6 col-sm-6 col-xs-6">
            {% block first_form %}
                <div class="kt-portlet kt-portlet--collapsed" data-ktportlet="true">
                    <div class="kt-portlet__head">
                        <div class="kt-portlet__head-label">
                            <h3 class="kt-portlet__head-title">Anomaly Injection</h3>
                        </div>
                        <div class="kt-portlet__head-toolbar">
                            <div class="kt-portlet__head-group">
                                <a href="#" data-ktportlet-tool="toggle"
                                   class="btn btn-sm btn-icon btn-default btn-icon-md myToggle"><i
                                        class="mdi mdi-chevron-down mdi-18px"></i></a>
                            </div>
                        </div>
                    </div>
                    <div class="kt-portlet__body kt-portlet__body--fit">
                        {% include 'sub/form.html' with form=injection_form form_id="injection_form" onclick="inject()" %}
                    </div>
                </div>
            {% endblock %}

            {% block second_form %}
                <div id="" class="kt-portlet kt-portlet--collapsed" data-ktportlet="true">
                    <div class="kt-portlet__head">
                        <div class="kt-portlet__head-label">
                            <h3 class="kt-portlet__head-title">Anomaly Repair</h3>
                        </div>
                        <div class="kt-portlet__head-toolbar">
                            <div class="kt-portlet__head-group">
                                <a href="#" data-ktportlet-tool="toggle"
                                   class="btn btn-sm btn-icon btn-default btn-icon-md myToggle"><i
                                        class="mdi mdi-chevron-down mdi-18px"></i></a>
                            </div>
                        </div>
                    </div>

                    <div class="kt-portlet__body kt-portlet__body--fit">
                        {% include 'sub/repairForm.html' %}
                    </div>
                </div>
            {% endblock %}
            {% block thirdblock %}

            {% endblock %}
        </div>
    </div>



    <script>
        Highcharts.dateFormats = {
            n: function (n) {
                return n.toFixed(0);
            }
        };

        let toggles = Array.from(document.getElementsByClassName("myToggle"));
        toggles.forEach(element => {
            element["on"] = false;
            element["primary"] = false;
        });

        toggles.forEach(element => {
            element.addEventListener("click", function (input) {
                element.on = !element.on;
                element.primary = true;
                toggles.forEach(other => {
                    if (other.on && !other.primary) {
                        other.click();
                    }
                });
                element.primary = false;
            })
        })

        let data_url = '{% url "get_data" setname=setname  %}' + '?viz={{ viz|default_if_none:5 }}';
        const mainchart = Highcharts.chart(document.getElementById('highcharts_container'), {

            tooltip: tooltip,


            chart: {
                type: 'line',
                zoomType: 'x',

            },

            {#xAxis: {#}
            {#    labels: {#}
            {#          pointInterval: 36e5, // one hour#}
            {#relativeXValue: true,#}
            {#        formatter: function () {#}
            {#            console.log("v" + this.value)#}
            {#            return this.value.toString();#}
            {#        },#}
            {#    }#}


            plotOptions: {
                series: {
                    pointStart: 1,
                    {#pointInterval: 36e5, // one hour,#}

                },
            },

            title: {
                text: chart_title
            },
            navigator: {
                xAxis : {
                    labels: {
                        formatter: function () {
                            return this.value.toString();
                        }
                    }
                },
                enabled: true,
                adaptToUpdatedData: true,
                height: 60
            },

            rangeSelector: {
                inputDateParser: function (value) {
                    console.log(value)
                    value = value.split(/[:\.]/);
                    return 1
                },
                enabled: true,
                inputEnabled: false,
                inputDateFormat: '%y',
                inputEditDateFormat: '%y',

                buttons: [{
                    type: 'millisecond',
                    count: 50,
                    text: '50'
                },
                    {

                        type: 'millisecond',
                        count: 1000,
                        text: '1000'
                    }, {
                        type: 'all',
                        text: 'All',
                        align: 'right',
                        x: 0,
                        y: 100,
                    }],
            },

            series: []
        });

        fetch(data_url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(response => response.json())
            .then(data => {
                data.series.forEach(x => mainchart.addSeries(x))
            })
            .catch(error => console.error(error))


    </script>
    {#    <script src="{% static 'js/additionalSeriesManager.js' %}" type="text/javascript"></script>#}


{% endblock %}

{% block additional_bottom_js %}

    <script src="{% static 'js/custom/form.extensions.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/page/detection/nouislider-init.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/page/detection/page.init.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/page/detection/form.init.js' %}" type="text/javascript"></script>

    <script type="text/javascript">
        let injection_url = "{% url 'inject_data' setname=setname %}"
        let repair_url = "{% url 'repair_data' setname=setname %}"
    </script>
    <script src="{% static 'js/injection.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/repair.js' %}" type="text/javascript"></script>


{% endblock %}

