{% extends "base.html" %}
{% load static %}

<!-- base template with a chart container of a dataset-->
{% block chartScript %}
    <script>
        let datasetName = "{{ set_name }}";
        let chart_title = "{{ data_title }}"

        let tooltip = {
            formatter: function (e) {
                // The first returned item is the header, subsequent items are the
                // points
                let x = this.x
                return ['<p style=\"color:black;font-size:15px;\"> Truth: ' + this.y + '</p>'].concat(
                    this.series.linkedSeries.map(function (s) {
                        selectedY = s.yData[x]
                        if (selectedY !== null) {
                            selectedY = Math.round(selectedY * 1000) / 1000
                            if (s.name.includes('injected')) {
                                return "<br> <p style=\"color:red;font-size:15px;\"> Anomalous: " + selectedY + "<\p> "
                            } else return "<br> <p style=\"color:" + s.color + ";font-size:15px;\">" + s.name + ": " + selectedY + "<\p> "
                        } else return ""
                    })
                );
            },
            shared: false,
            valueDecimals: 2
        }

        let range_selector = {
            buttons: [{
                count: 1,
                text: '1m',
                events: {
                    click: function () {
                        alert('Clicked button');
                    }
                }
            },
                {
                    count: 3,
                    text: '3m'
                }
            ],
            enabled: true,
        }
    </script>
{% endblock %}


{% block chart %}
    <script src="{% static 'js/lib/binarytransport/jquery.binarytransport.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/lib/highcharts/highstock.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/custom/highcharts.utils.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/custom/highcharts.line.view.init.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/custom/highcharts.actions.init.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/custom/form.extensions.js' %}" type="text/javascript"></script>

    <div class="row">
        <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12">
            <div class="kt-portlet">
                <div class="kt-portlet__head">
                    <div class="kt-portlet__head-label">
                        <h3 class="kt-portlet__head-title">{{ data_title }}</h3>
                    </div>
                    <div class="kt-portlet__head-toolbar">
                        <div id="highcharts_head_actions" class="kt-portlet__head-actions">
                            <a id="reset_chart_btn" href="#" class="btn btn-outline-brand btn-bold btn-sm">Reset</a>
                            <div class="dropdown dropdown-inline">
                                <a href="#" class="btn btn-outline-brand btn-icon btn-sm" data-toggle="dropdown"
                                   aria-haspopup="true" aria-expanded="false">
                                    <i class="mdi mdi-18px mdi-dots-horizontal"></i>
                                </a>
                                {#                                {% include 'vadetisweb/parts/misc/highcharts_line_dropdown.html' %}#}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="kt-portlet__body kt-portlet__body--fit">
                    <!--begin: Highcharts -->
                    <div id="highcharts_container"></div>
                    <!--end: Highcharts -->
                </div>
            </div>
            <!--begin: Inner Row -->
            <div id="container2" class="row"></div>
            <div id="detection_portlets" class="row"></div>
            <!--end: Inner Row -->
        </div>
        <!--end: Inner Row -->
        <div id="form_portlets" class="col-lg-3 col-md-12 col-sm-12 col-xs-12">
            <div class="kt-portlet kt-portlet--collapsed" data-ktportlet="true">
                <div class="kt-portlet__head">
                    <div class="kt-portlet__head-label">
                        <h3 class="kt-portlet__head-title">Anomaly Injection</h3>
                    </div>
                    <div class="kt-portlet__head-toolbar">
                        <div class="kt-portlet__head-group">
                            <a href="#" data-ktportlet-tool="toggle"
                               class="btn btn-sm btn-icon btn-default btn-icon-md"><i
                                    class="mdi mdi-chevron-down mdi-18px"></i></a>
                        </div>
                    </div>
                </div>
                <div class="kt-portlet__body kt-portlet__body--fit">
                    {% include 'sub/form.html' with form=injection_form form_id="injection_form" onclick="inject()" %}

                    <div id="form_append_container"></div>
                </div>
            </div>
            <div id="" class="kt-portlet kt-portlet--collapsed" data-ktportlet="true">
                <div class="kt-portlet__head">
                    <div class="kt-portlet__head-label">
                        <h3 class="kt-portlet__head-title">Anomaly Repair</h3>
                    </div>
                    <div class="kt-portlet__head-toolbar">
                        <div class="kt-portlet__head-group">
                            <a href="#" data-ktportlet-tool="toggle"
                               class="btn btn-sm btn-icon btn-default btn-icon-md"><i
                                    class="mdi mdi-chevron-down mdi-18px" onclick="return false"></i></a>
                        </div>
                    </div>
                </div>

                <div class="kt-portlet__body kt-portlet__body--fit">
                    {% include 'sub/repairForm.html' %}

                    {#                    {% url 'vadetisweb:detection_algorithm_selection' dataset_id=dataset.id as detection_url %}#}
                    {#                    {% include 'vadetisweb/parts/forms/serializer_on_change_submit_form.html' with formid="anomaly_algorithm_form" url=detection_url form_serializer=detection_serializer %}#}
                </div>
            </div>
        </div>
    </div>



    <script>
        let data_url = '{% url "get_data" setname=setname  %}' + '?viz={{ viz|default_if_none:5 }}';
        const mainchart = Highcharts.chart(document.getElementById('highcharts_container'), {

            tooltip: tooltip,

            chart: {
                type: 'line',
                zoomType: 'x',

            },

            title: {
                text: chart_title
            },


            {#rangeSelector :range_selector,#}

            series: []
        });

        fetch(data_url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(response => response.json())
            .then(data => {
                data.series.forEach(x => mainchart.addSeries(x))
            })
            .catch(error => console.error(error))


    </script>


{% endblock %}

{% block additional_bottom_js %}

    <script src="{% static 'js/custom/form.extensions.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/page/detection/nouislider-init.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/page/detection/page.init.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/page/detection/form.init.js' %}" type="text/javascript"></script>


    <script type="text/javascript">
        let injection_url = "{% url 'inject_data' setname=setname %}"
        let repair_url = "{% url 'repair_data' setname=setname %}"
    </script>
    <script src="{% static 'js/injection.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/repair.js' %}" type="text/javascript"></script>


{% endblock %}

